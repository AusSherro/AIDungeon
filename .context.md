# AI Dungeon Master - AI Context

> This file provides context for AI assistants working with this codebase.
> Repository: https://github.com/AusSherro/AIDungeon

## Project Overview

A Discord bot that acts as an AI Dungeon Master for D&D 5e campaigns. It uses GPT-4o for narrative generation and ElevenLabs for text-to-speech, enabling voice-narrated tabletop RPG sessions.

**Version:** 0.7.0  
**Features:** Full D&D 5e mechanics, tactical maps, player handouts, SQLite storage, XP/loot systems, combat reactions, ambient audio

## Architecture

```
┌─────────────────┐     ┌──────────────────┐
│  Discord Bot    │────▶│  OpenAI GPT-4o   │
│ (discord_bot.py)│     │ (narration/DM)   │
└────────┬────────┘     └──────────────────┘
         │
         ├────────────────────────────────┐
         ▼                                ▼
┌─────────────────┐     ┌──────────────────────────┐
│  Voice Channel  │◀────│  ElevenLabs TTS          │
│  (FFmpeg audio) │     │  (with Edge TTS fallback)│
└─────────────────┘     └──────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│                 Persistent State                     │
│  state/ │ characters/ │ combat/ │ logs/ │ handouts/ │
│                    │ maps/ │ data/                   │
└─────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────┐     ┌──────────────────┐
│  Web Portal     │     │  SQLite Database │
│  (Flask @ 5000) │     │  (data/aidm.db)  │
└─────────────────┘     └──────────────────┘
```

## Key Components

### Entry Points
- **discord_bot.py** - Main Discord bot with 50+ slash commands (primary interface)
- **app.py** - Flask web portal for character management and DM dashboard

### Services
- **services/openai_service.py** - GPT-4o integration for DM responses and campaign generation
- **services/elevenlabs_service.py** - Text-to-speech conversion with Edge TTS fallback
- **services/story_manager.py** - Campaign narrative and NPC tracking
- **services/prompt_config.txt** - DM personality/behavior prompt

### Core Utilities
- **utils/state_manager.py** - JSON-based session persistence with backup/restore
- **utils/character_manager.py** - Full D&D 5e character sheet management with equipment and conditions
- **utils/combat_manager.py** - Combat encounters with legendary actions, lair actions, readied actions
- **utils/dice_roller.py** - Dice notation parsing with advantage/disadvantage, keep highest/lowest

### New Feature Utilities
- **utils/dnd5e_data.py** - D&D 5e reference data:
  - 37 weapons with damage dice, properties, categories
  - 13 armor types with AC calculations
  - 16 conditions with mechanical effects
  - 40 feats with prerequisites and effects
  - 15+ monster statblocks (CR 1/8 to CR 8)
- **utils/handout_manager.py** - Player handouts and secrets system
- **utils/map_manager.py** - Tactical battle maps with tokens and terrain
- **utils/database.py** - SQLite storage layer for all data types

### Voice & Logging
- **utils/voice_parser.py** - Extracts `[Voice: CharacterName]` tags from AI responses
- **utils/voice_map.py** - Maps character names to ElevenLabs voice IDs
- **utils/voice_manager.py** - Discord voice channel connection management
- **utils/logger.py** - Markdown session logging
- **utils/session_recorder.py** - Full session recording

### Web Portal
- **webportal/routes.py** - Flask routes for character/campaign management
- **webportal/templates/** - HTML templates for web interface

### Configuration
- **config.py** - Centralized configuration with directory management
- **.env** - API keys (DISCORD_BOT_TOKEN, OPENAI_API_KEY, ELEVENLABS_API_KEY, DEV_GUILD_ID)

## Slash Commands (50+)

### Campaign & Story
| Command | Description |
|---------|-------------|
| `/campaign` | Start a new campaign |
| `/context` | View campaign summary, NPCs, quests |
| `/recap` | Get a summary of recent events |
| `/remember <info>` | Store important information |
| `/summarize` | Generate campaign summary |

### Character Management
| Command | Description |
|---------|-------------|
| `/character <name> <race> <class>` | Create a character |
| `/stats` | View full character sheet |
| `/stats set <ability> <value>` | Set ability score |
| `/levelup` | Level up your character |
| `/inventory add/remove/list` | Manage inventory |
| `/status` | View HP, conditions, spell slots |

### Gameplay
| Command | Description |
|---------|-------------|
| `/do <action>` | Take an action (narrated by AI) |
| `/say <dialogue>` | Speak in character |
| `/roll <dice>` | Roll dice (supports advantage, modifiers) |
| `/turns` | View turn order |
| `/done` | End your turn |

### Combat
| Command | Description |
|---------|-------------|
| `/fight <enemies>` | Start combat encounter |
| `/attack <target>` | Attack a target |
| `/combatinfo` | View all combatants |
| `/nextturn` | Advance initiative |
| `/endcombat` | End the encounter |
| `/hp damage/heal/set` | Modify HP |
| `/deathsave` | Roll death saving throw |

### Spellcasting
| Command | Description |
|---------|-------------|
| `/learn <spell>` | Learn a spell |
| `/learn cantrip <cantrip>` | Learn a cantrip |
| `/prepare <spell>` | Prepare a spell |
| `/cast <spell> [target]` | Cast a spell |
| `/spells` | View known/prepared spells |

### Rest & Recovery
| Command | Description |
|---------|-------------|
| `/rest short` | Short rest (1 hour) - spend Hit Dice |
| `/rest long` | Long rest (8 hours) - full recovery |

### Tactical Maps
| Command | Description |
|---------|-------------|
| `/newmap <name> <w> <h> [template]` | Create tactical map |
| `/map` | View current map |
| `/addtoken <name> <x> <y>` | Add token to map |
| `/movetoken <name> <x> <y>` | Move a token |
| `/removetoken <name>` | Remove token |
| `/setterrain <x> <y> <type>` | Set terrain |
| `/distance <t1> <t2>` | Measure distance |
| `/inrange <token> <feet>` | Find tokens in range |
| `/clearmap` | Delete current map |

### Player Handouts
| Command | Description |
|---------|-------------|
| `/handout <title> <content>` | Create handout (DM) |
| `/secret <player> <title> <content>` | Create secret (DM) |
| `/viewhandouts` | View your handouts |
| `/readhandout <id>` | Read a handout |
| `/mysecrets` | View your secrets |
| `/dmhandouts` | View all handouts (DM) |
| `/revealhandout <id>` | Reveal handout (DM) |
| `/sharehandout <id> <player>` | Share handout (DM) |
| `/deletehandout <id>` | Delete handout (DM) |

### Voice & Utility
| Command | Description |
|---------|-------------|
| `/voice` | Join voice channel |
| `/leave` | Leave voice channel |
| `/exportlog` | Download session log |
| `/help` | Show all commands |

## D&D 5e Data Reference

### Equipment System
- **Weapons (37):** Simple melee, martial melee, simple ranged, martial ranged
  - Properties: finesse, versatile, two-handed, thrown, ammunition, etc.
- **Armor (13):** Light, medium, heavy armor + shields
  - AC calculations based on type and Dexterity

### Conditions (16)
Blinded, Charmed, Deafened, Exhaustion (6 levels), Frightened, Grappled, Incapacitated, Invisible, Paralyzed, Petrified, Poisoned, Prone, Restrained, Stunned, Unconscious

### Feats (40)
Full SRD feats with prerequisites, ability score increases, and mechanical effects

### Monsters (15+)
Pre-built statblocks from CR 1/8 to CR 8:
- Goblin, Kobold, Skeleton, Zombie, Orc
- Dire Wolf, Giant Spider, Owlbear, Troll
- Bandit, Bandit Captain, Cultist, Mage, Knight
- Young Dragon (template)

## Data Flow

1. Player uses slash command (e.g., `/do I search the room`)
2. Bot validates turn order and character state
3. Action sent to GPT-4o with full context (character, combat, NPCs, history)
4. AI responds with narration containing `[Voice: CharacterName]` tags
5. Voice tags extracted, text sent to ElevenLabs (or Edge TTS fallback)
6. Audio played in Discord voice channel via FFmpeg
7. State updated and saved to JSON (and optionally SQLite)
8. Session logged to markdown file

## State Structures

### Game State (`state/<channel_id>.json`)
```json
{
  "campaign": "campaign intro text",
  "campaign_summary": "ongoing summary",
  "messages": [{"role": "user/assistant", "content": "..."}],
  "turn_order": ["user_id_1", "user_id_2"],
  "current_turn_index": 0,
  "npcs": {"Name": {"description": "...", "disposition": "friendly"}},
  "quests": [{"name": "...", "status": "active"}],
  "key_events": ["event1", "event2"]
}
```

### Character Sheet (`characters/<user_id>.json`)
```json
{
  "name": "Thorin",
  "race": "Dwarf",
  "class": "Fighter",
  "level": 3,
  "abilities": {"strength": 16, "dexterity": 12, ...},
  "hp": {"current": 28, "max": 30, "temp": 0},
  "ac": 18,
  "skills": {"athletics": "proficient", "perception": "expertise"},
  "spell_slots": {"1st": {"max": 0, "used": 0}},
  "known_spells": [],
  "prepared_spells": [],
  "inventory": ["Battleaxe", "Chain Mail", "Shield"],
  "conditions": [],
  "death_saves": {"successes": 0, "failures": 0}
}
```

### Combat State (`combat/<channel_id>.json`)
```json
{
  "active": true,
  "combatants": [
    {"name": "Thorin", "initiative": 18, "hp": 28, "max_hp": 30, "ac": 18},
    {"name": "Goblin1", "initiative": 12, "hp": 7, "max_hp": 7, "ac": 13}
  ],
  "current_turn": 0,
  "round": 1,
  "legendary_actions": {},
  "lair_actions": [],
  "readied_actions": {}
}
```

## Web Portal Routes

- `GET /portal/` - DM Dashboard
- `GET /portal/characters` - Character list
- `GET /portal/character/<id>` - Character detail
- `GET /portal/character/<id>/edit` - Edit character
- `POST /portal/character/create` - Create character
- `GET /portal/campaign/<id>/summary` - Campaign summary
- `GET /portal/spells/<id>` - Spell management

## Common Development Tasks

### Adding a New Slash Command
```python
@bot.tree.command(name="command_name", description="Description")
@app_commands.describe(param="Parameter description")
async def command_name(interaction: discord.Interaction, param: str):
    await interaction.response.send_message(f"Result: {param}")
```

### Adding a New Monster
Edit `utils/dnd5e_data.py`:
```python
MONSTERS["monster_name"] = {
    "name": "Monster Name",
    "size": "Medium",
    "type": "humanoid",
    "ac": 13,
    "hp": 22,
    "speed": "30 ft.",
    "abilities": {"STR": 14, "DEX": 12, "CON": 13, "INT": 8, "WIS": 10, "CHA": 8},
    "cr": "1/2",
    "attacks": [{"name": "Sword", "bonus": 4, "damage": "1d8+2", "type": "slashing"}]
}
```

### Adding a New Voice Character
Edit `utils/voice_map.py`:
```python
VOICE_MAP = {
    'New Character': 'elevenlabs-voice-id',
}
```

### Modifying DM Behavior
Edit the system prompt in `utils/prompt_builder.py` or `services/prompt_config.txt`

## Dependencies

- **discord.py 2.3+** - Discord API with slash commands
- **openai 1.0+** - OpenAI API client
- **flask 3.0+** - Web portal framework
- **requests** - HTTP client for ElevenLabs
- **python-dotenv** - Environment variable loading
- **PyNaCl** - Voice encryption (required for voice channels)
- **edge-tts** - Free TTS fallback

## Testing Locally

1. Set up `.env` with API keys:
   ```
   DISCORD_BOT_TOKEN=your_token
   OPENAI_API_KEY=your_key
   ELEVENLABS_API_KEY=your_key
   DEV_GUILD_ID=your_guild_id
   ```
2. Install dependencies: `pip install -r requirements.txt`
3. Run `python discord_bot.py`
4. Use `/help` to see all commands
5. Web portal available at `http://localhost:5000/portal/`

## File Structure

```
AIDungeon/
├── discord_bot.py          # Main bot (50+ commands)
├── app.py                  # Flask web portal
├── config.py               # Configuration
├── requirements.txt        # Dependencies
├── .env                    # API keys (not in git)
├── services/
│   ├── openai_service.py   # GPT-4o integration
│   ├── elevenlabs_service.py # TTS service
│   └── story_manager.py    # Narrative tracking
├── utils/
│   ├── character_manager.py # Character sheets
│   ├── combat_manager.py    # Combat system
│   ├── dnd5e_data.py        # D&D reference data
│   ├── handout_manager.py   # Player handouts
│   ├── map_manager.py       # Tactical maps
│   ├── database.py          # SQLite storage
│   ├── dice_roller.py       # Dice rolling
│   ├── state_manager.py     # Session state
│   ├── xp_manager.py        # XP tracking
│   ├── loot_manager.py      # Treasure generation
│   ├── reaction_manager.py  # Combat reactions
│   ├── ambient_manager.py   # Music/SFX
│   └── voice_*.py           # Voice utilities
├── webportal/
│   ├── routes.py            # Flask routes
│   └── templates/           # HTML templates
├── state/                   # Session JSON files
├── characters/              # Character JSON files
├── combat/                  # Combat JSON files
├── logs/                    # Session markdown logs
├── handouts/                # Handout JSON files
├── maps/                    # Map JSON files
└── data/                    # SQLite database
```

## Known Limitations

- Voice output requires FFmpeg installed on system
- Global command sync can take up to 1 hour on Discord
- Character data is per-Discord-user, not per-campaign
- Map size limited to ~20x20 for Discord message display
- ElevenLabs has API rate limits (fallback to Edge TTS)
