{% extends "base.html" %}

{% block title %}{{ char.name }} - AI Dungeon Master{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div>
            <h1>{{ char.name }}</h1>
            <p>
                <span class="tag tag-race">{{ char.race or 'Unknown Race' }}</span>
                <span class="tag tag-class">{{ char.class or 'Unknown Class' }}</span>
                <span class="tag tag-level">Level {{ char.level or 1 }}</span>
            </p>
        </div>
        <div class="button-group">
            <form method="POST" action="{{ url_for('portal.sync_character', char_id=char_id) }}" style="display:inline;">
                <button type="submit" class="btn btn-success" title="Sync spell slots and features with class/level">üîÑ Sync</button>
            </form>
            <a href="{{ url_for('portal.edit_character', char_id=char_id) }}" class="btn btn-primary">‚úèÔ∏è Edit</a>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">üóëÔ∏è Delete</button>
        </div>
    </div>
    
    <!-- HP Bar -->
    <div class="form-group">
        <label>Hit Points</label>
        {% set hp_percent = ((char.hp or 0) / (char.max_hp or 1) * 100) | int %}
        <div class="hp-bar">
            <div class="hp-bar-fill" style="width: {{ hp_percent }}%"></div>
            <div class="hp-bar-text">{{ char.hp or 0 }} / {{ char.max_hp or 0 }}</div>
        </div>
    </div>
</div>

<!-- Ability Scores -->
<div class="card">
    <h2>‚öîÔ∏è Ability Scores</h2>
    <br>
    <div class="grid grid-6">
        {% for stat in ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'] %}
        {% set value = char.get(stat, 10) %}
        {% set mod = ((value - 10) // 2) %}
        <div class="stat-box">
            <div class="stat-name">{{ stat }}</div>
            <div class="stat-value">{{ value }}</div>
            <div class="stat-mod">{% if mod >= 0 %}+{% endif %}{{ mod }}</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Combat Stats -->
<div class="card">
    <h2>üõ°Ô∏è Combat Stats</h2>
    <br>
    <div class="grid grid-3">
        <div class="stat-box">
            <div class="stat-name">Armor Class</div>
            <div class="stat-value">{{ char.ac or 10 }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-name">Initiative</div>
            {% set dex_mod = ((char.get('DEX', 10) - 10) // 2) %}
            <div class="stat-value">{% if dex_mod >= 0 %}+{% endif %}{{ dex_mod }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-name">Proficiency</div>
            {% set prof = 2 + ((char.level or 1) - 1) // 4 %}
            <div class="stat-value">+{{ prof }}</div>
        </div>
    </div>
</div>

<!-- Inventory -->
<div class="card">
    <div class="card-header">
        <h2>üéí Inventory</h2>
    </div>
    
    {% if char.inventory %}
    <div class="inventory-grid">
        {% for item in char.inventory %}
        <div class="inventory-item">
            <span>{{ item }}</span>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state" style="padding: 30px;">
        <p>No items in inventory.</p>
    </div>
    {% endif %}
</div>

<!-- Spellcasting -->
{% set total_slots = (char.spell_slots.get('1', 0)|int + char.spell_slots.get('2', 0)|int + char.spell_slots.get('3', 0)|int + char.spell_slots.get('4', 0)|int + char.spell_slots.get('5', 0)|int) if char.spell_slots else 0 %}
{% set has_spells = total_slots > 0 %}
{% set has_cantrips = char.cantrips_known and char.cantrips_known|length > 0 %}
{% set has_known_spells = char.spells_known and char.spells_known|length > 0 %}
{% set has_prepared_spells = char.prepared_spells and char.prepared_spells|length > 0 %}
{% set has_features = char.features and char.features|length > 0 %}

{% if has_spells or has_cantrips or has_known_spells or has_prepared_spells %}
<div class="card">
    <div class="card-header">
        <h2>‚ú® Spellcasting</h2>
        <a href="{{ url_for('portal.manage_spells', char_id=char_id) }}" class="btn btn-primary">üìñ Manage Spells</a>
    </div>
    
    <!-- Spell Slots -->
    {% if has_spells %}
    <div class="form-group">
        <label>Spell Slots</label>
        <div class="spell-slots-grid">
            {% for level in range(1, 10) %}
            {% set total = char.spell_slots.get(level|string, 0) %}
            {% set used = char.spell_slots_used.get(level|string, 0) if char.spell_slots_used else 0 %}
            {% set remaining = total - used %}
            {% if total > 0 %}
            <div class="spell-slot-level">
                <div class="spell-slot-label">Level {{ level }}</div>
                <div class="spell-slot-circles">
                    {% for i in range(total) %}
                    <span class="spell-slot-circle {% if i < remaining %}filled{% else %}empty{% endif %}">‚óè</span>
                    {% endfor %}
                </div>
                <div class="spell-slot-count">{{ remaining }}/{{ total }}</div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Cantrips -->
    {% if has_cantrips %}
    <div class="form-group">
        <label>Cantrips</label>
        <div class="spell-list">
            {% for cantrip in char.cantrips_known %}
            <span class="spell-tag cantrip">{{ cantrip }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Known Spells -->
    {% if has_known_spells %}
    <div class="form-group">
        <label>Known Spells</label>
        <div class="spell-list">
            {% for spell in char.spells_known %}
            <span class="spell-tag known">{{ spell }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Prepared Spells -->
    {% if has_prepared_spells %}
    <div class="form-group">
        <label>Prepared Spells</label>
        <div class="spell-list">
            {% for spell in char.prepared_spells %}
            <span class="spell-tag prepared">{{ spell }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Features -->
{% if char.features and char.features|length > 0 %}
<div class="card">
    <div class="card-header">
        <h2>üìú Features & Traits</h2>
    </div>
    <div class="features-list">
        {% for feature in char.features %}
        <div class="feature-item">{{ feature }}</div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Experience -->
{% if char.xp is defined %}
<div class="card">
    <h2>‚≠ê Experience</h2>
    <br>
    <div class="stat-box">
        <div class="stat-name">XP</div>
        <div class="stat-value">{{ char.xp or 0 }}</div>
    </div>
</div>
{% endif %}

<br>
<a href="{{ url_for('portal.list_characters') }}" class="btn btn-secondary">‚Üê Back to Characters</a>

<!-- Hidden delete form -->
<form id="deleteForm" method="POST" action="{{ url_for('portal.delete_character', char_id=char_id) }}" style="display: none;"></form>
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete() {
    if (confirm('Are you sure you want to delete {{ char.name }}? This cannot be undone!')) {
        document.getElementById('deleteForm').submit();
    }
}
</script>
{% endblock %}
