# AI Dungeon Master - AI Context

> This file provides context for AI assistants working with this codebase.
> Repository: https://github.com/AusSherro/AIDungeon

## Project Overview

A Discord bot that acts as an AI Dungeon Master for D&D 5e campaigns. It uses GPT-4o for narrative generation and ElevenLabs for text-to-speech, enabling voice-narrated tabletop RPG sessions.

## Architecture

```
┌─────────────────┐     ┌──────────────────┐
│  Discord Bot    │────▶│  OpenAI GPT-4o   │
│ (discord_bot.py)│     │ (narration/DM)   │
└────────┬────────┘     └──────────────────┘
         │
         ▼
┌─────────────────┐     ┌──────────────────┐
│  Voice Channel  │◀────│  ElevenLabs TTS  │
│  (FFmpeg audio) │     │ (voice output)   │
└─────────────────┘     └──────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│           Persistent State              │
│  state/ │ characters/ │ combat/ │ logs/ │
└─────────────────────────────────────────┘
```

## Key Components

### Entry Points
- **discord_bot.py** - Main Discord bot with slash commands (primary interface)
- **app.py** - Flask REST API for programmatic access (optional)

### Services
- **services/openai_service.py** - GPT-4o integration for DM responses and campaign generation
- **services/elevenlabs_service.py** - Text-to-speech conversion
- **services/prompt_config.txt** - DM personality/behavior prompt (alternative to hardcoded)

### Utilities
- **utils/state_manager.py** - JSON-based session persistence with backup/restore
- **utils/character_manager.py** - Full D&D 5e character sheet management
- **utils/combat_manager.py** - Combat encounter tracking (initiative, HP, turns)
- **utils/dice_roller.py** - Dice notation parsing and rolling with modifiers
- **utils/voice_parser.py** - Extracts `[Voice: CharacterName]` tags from AI responses
- **utils/voice_map.py** - Maps character names to ElevenLabs voice IDs
- **utils/logger.py** - Markdown session logging
- **utils/command_sync.py** - Discord slash command registration utilities

### Configuration
- **config.py** - Centralized configuration with directory management
- **.env** - API keys (DISCORD_BOT_TOKEN, OPENAI_API_KEY, ELEVENLABS_API_KEY)

## Data Flow

1. Player uses `/act <action>` slash command
2. Bot validates it's their turn (turn order tracked in state)
3. Action sent to GPT-4o with character/combat context
4. AI responds with narration containing `[Voice: X]` tags
5. Voice tags extracted, text sent to ElevenLabs
6. Audio played in Discord voice channel via FFmpeg
7. State updated and saved to JSON

## Game State Structure

```json
{
  "campaign": "campaign intro text",
  "messages": [{"role": "user/assistant", "content": "..."}],
  "turn_order": ["user_id_1", "user_id_2"],
  "current_turn_index": 0,
  "characters": {},
  "combat": {}
}
```

## Character Sheet Structure

Full D&D 5e character with:
- Ability scores (STR, DEX, CON, INT, WIS, CHA)
- Skills with proficiency/expertise
- HP, AC, spell slots, conditions
- Inventory and equipment
- Death saves, rest mechanics

## Common Tasks

### Adding a new slash command
Add to `discord_bot.py` using `@bot.tree.command()` decorator:
```python
@bot.tree.command(name="command_name", description="Description")
async def command_name(interaction: discord.Interaction):
    await interaction.response.send_message("Response")
```

### Adding a new voice character
Edit `utils/voice_map.py`:
```python
VOICE_MAP = {
    'New Character': 'elevenlabs-voice-id',
}
```

### Modifying DM behavior
Edit the `SYSTEM_PROMPT` in `services/openai_service.py`

## Dependencies

- **discord.py** - Discord API wrapper with slash commands
- **openai** - OpenAI API client (v1.0+ syntax)
- **flask** - REST API framework
- **requests** - HTTP client for ElevenLabs
- **python-dotenv** - Environment variable loading
- **PyNaCl** - Voice encryption (required for voice channels)

## Testing Locally

1. Set up `.env` with API keys
2. Run `python discord_bot.py`
3. Use `/sync_now` if commands don't appear
4. Join a voice channel and use `/new_campaign`

## Known Limitations

- Voice output requires FFmpeg installed on system
- Global command sync can take up to 1 hour on Discord
- Character data is per-Discord-user, not per-campaign
